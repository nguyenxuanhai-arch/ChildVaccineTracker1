<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title>Đặt lịch hẹn - Hệ thống Quản lý Tiêm chủng</title>
    <style>
        .service-card {
            cursor: pointer;
            transition: all 0.3s;
        }
        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
        }
        .service-card.selected {
            border: 2px solid #4e73df;
            background-color: rgba(78, 115, 223, 0.05);
        }
        .time-slot {
            cursor: pointer;
            transition: all 0.2s;
        }
        .time-slot:hover {
            background-color: #f8f9fc;
        }
        .time-slot.selected {
            background-color: #4e73df;
            color: white;
        }
        .time-slot.unavailable {
            background-color: #e0e0e0;
            color: #888;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div layout:fragment="content">
        <div class="container-fluid py-4">
            <h1 class="h3 mb-4 text-gray-800">Đặt lịch hẹn tiêm chủng</h1>
            
            <!-- Messages -->
            <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                <span th:text="${successMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <span th:text="${errorMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div th:if="${warning}" class="alert alert-warning alert-dismissible fade show" role="alert">
                <span th:text="${warning}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            
            <!-- Booking Steps -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Quy trình đặt lịch hẹn</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-xl-12">
                            <div class="mb-4">
                                <div class="progress" style="height: 25px;">
                                    <div id="booking-progress" class="progress-bar" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">Bước 1/4</div>
                                </div>
                            </div>
                            
                            <ul class="nav nav-tabs" id="bookingTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="step1-tab" data-bs-toggle="tab" data-bs-target="#step1" type="button" role="tab" aria-controls="step1" aria-selected="true">
                                        <i class="fas fa-child me-1"></i> Chọn trẻ
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link disabled" id="step2-tab" data-bs-toggle="tab" data-bs-target="#step2" type="button" role="tab" aria-controls="step2" aria-selected="false">
                                        <i class="fas fa-clipboard-list me-1"></i> Chọn dịch vụ
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link disabled" id="step3-tab" data-bs-toggle="tab" data-bs-target="#step3" type="button" role="tab" aria-controls="step3" aria-selected="false">
                                        <i class="fas fa-calendar-alt me-1"></i> Chọn ngày & giờ
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link disabled" id="step4-tab" data-bs-toggle="tab" data-bs-target="#step4" type="button" role="tab" aria-controls="step4" aria-selected="false">
                                        <i class="fas fa-check-circle me-1"></i> Xác nhận & Đặt lịch
                                    </button>
                                </li>
                            </ul>
                            
                            <form id="appointmentForm" th:action="@{/customer/appointments/book}" method="post" th:object="${appointmentDTO}">
                                <div class="tab-content p-4 border border-top-0 rounded-bottom" id="bookingTabContent">
                                    <!-- Step 1: Select Child -->
                                    <div class="tab-pane fade show active" id="step1" role="tabpanel" aria-labelledby="step1-tab">
                                        <h5 class="mb-4">Chọn trẻ cho lịch hẹn</h5>
                                        
                                        <div class="row">
                                            <div th:each="child : ${children}" class="col-lg-4 col-md-6 mb-4">
                                                <div class="card child-card service-card h-100">
                                                    <div class="card-body text-center">
                                                        <input type="radio" name="childId" th:id="${'child-' + child.id}" th:value="${child.id}" th:field="*{childId}" class="d-none" />
                                                        <div class="mb-3">
                                                            <img class="img-profile rounded-circle" style="width: 80px; height: 80px;"
                                                                 src="https://via.placeholder.com/150" alt="Ảnh trẻ">
                                                        </div>
                                                        <h5 class="card-title" th:text="${child.fullName}">Tên trẻ</h5>
                                                        <p class="card-text text-muted">
                                                            <span th:with="age=${T(java.time.Period).between(child.dateOfBirth, T(java.time.LocalDate).now())}">
                                                                <span th:text="${age.years}">0</span> tuổi
                                                                <span th:text="${age.months}">0</span> tháng
                                                            </span>
                                                        </p>
                                                        <span class="badge" th:classappend="${child.gender == T(com.vaccine.entity.Child.Gender).MALE ? 'bg-info' : 'bg-danger'}" 
                                                              th:text="${child.gender == T(com.vaccine.entity.Child.Gender).MALE ? 'Nam' : 'Nữ'}">Giới tính</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div th:if="${children.isEmpty()}" class="text-center py-5">
                                            <i class="fas fa-child fa-3x text-muted mb-3"></i>
                                            <h5>Chưa có hồ sơ trẻ</h5>
                                            <p class="text-muted">Bạn cần thêm hồ sơ trẻ trước khi đặt lịch hẹn.</p>
                                            <a th:href="@{/customer/children/add}" class="btn btn-primary">
                                                Thêm hồ sơ trẻ
                                            </a>
                                        </div>
                                        
                                        <div class="mt-4 text-end">
                                            <button type="button" id="step1NextBtn" class="btn btn-primary" disabled>
                                                Tiếp theo <i class="fas fa-arrow-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Step 2: Select Service -->
                                    <div class="tab-pane fade" id="step2" role="tabpanel" aria-labelledby="step2-tab">
                                        <h5 class="mb-4">Chọn dịch vụ tiêm chủng</h5>
                                        
                                        <div class="mb-4">
                                            <ul class="nav nav-pills mb-3" id="serviceTypeTab" role="tablist">
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link active" id="all-services-tab" data-bs-toggle="pill" data-bs-target="#all-services" type="button" role="tab">Tất cả dịch vụ</button>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link" id="individual-vaccines-tab" data-bs-toggle="pill" data-bs-target="#individual-vaccines" type="button" role="tab">Vắc-xin đơn lẻ</button>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link" id="packages-tab" data-bs-toggle="pill" data-bs-target="#packages" type="button" role="tab">Gói dịch vụ</button>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link" id="recommended-tab" data-bs-toggle="pill" data-bs-target="#recommended" type="button" role="tab">Đề xuất</button>
                                                </li>
                                            </ul>
                                            
                                            <div class="tab-content" id="serviceTypeTabContent">
                                                <div class="tab-pane fade show active" id="all-services" role="tabpanel">
                                                    <div class="row">
                                                        <div th:each="service : ${services}" class="col-md-6 col-lg-4 mb-4">
                                                            <div class="card service-card h-100">
                                                                <div class="card-body">
                                                                    <input type="radio" name="serviceId" th:id="${'service-' + service.id}" th:value="${service.id}" th:field="*{serviceId}" class="d-none" />
                                                                    <div class="d-flex justify-content-between mb-3">
                                                                        <h5 class="card-title" th:text="${service.name}">Tên dịch vụ</h5>
                                                                        <span class="badge" th:classappend="${
                                                                            service.type == T(com.vaccine.entity.Service.ServiceType).INDIVIDUAL_VACCINE ? 'bg-info' : 
                                                                            service.type == T(com.vaccine.entity.Service.ServiceType).PACKAGE ? 'bg-success' : 'bg-warning'
                                                                        }" th:text="${service.type}">Type</span>
                                                                    </div>
                                                                    <p class="card-text" th:text="${#strings.abbreviate(service.description, 120)}">Mô tả dịch vụ</p>
                                                                    <div class="mb-3">
                                                                        <small class="text-muted">Vắc-xin bao gồm:</small>
                                                                        <ul class="list-group list-group-flush small">
                                                                            <li class="list-group-item px-0" th:each="vaccine : ${service.vaccines}" th:text="${vaccine.name}">Tên vắc-xin</li>
                                                                            <li class="list-group-item px-0 text-muted" th:if="${service.vaccines.isEmpty()}">Vắc-xin tùy chỉnh theo nhu cầu</li>
                                                                        </ul>
                                                                    </div>
                                                                    <div class="d-flex justify-content-between">
                                                                        <span class="fw-bold" th:text="${'₫' + service.price}">₫100.000</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="tab-pane fade" id="individual-vaccines" role="tabpanel">
                                                    <div class="row">
                                                        <div th:each="service : ${services}" th:if="${service.type == T(com.vaccine.entity.Service.ServiceType).INDIVIDUAL_VACCINE}" 
                                                             class="col-md-6 col-lg-4 mb-4">
                                                            <div class="card service-card h-100">
                                                                <div class="card-body">
                                                                    <input type="radio" name="serviceId" th:id="${'service-' + service.id}" th:value="${service.id}" th:field="*{serviceId}" class="d-none" />
                                                                    <div class="d-flex justify-content-between mb-3">
                                                                        <h5 class="card-title" th:text="${service.name}">Tên dịch vụ</h5>
                                                                        <span class="badge bg-info" th:text="${service.type}">Loại</span>
                                                                    </div>
                                                                    <p class="card-text" th:text="${#strings.abbreviate(service.description, 120)}">Mô tả dịch vụ</p>
                                                                    <div class="mb-3">
                                                                        <small class="text-muted">Vắc-xin bao gồm:</small>
                                                                        <ul class="list-group list-group-flush small">
                                                                            <li class="list-group-item px-0" th:each="vaccine : ${service.vaccines}" th:text="${vaccine.name}">Tên vắc-xin</li>
                                                                        </ul>
                                                                    </div>
                                                                    <div class="d-flex justify-content-between">
                                                                        <span class="fw-bold" th:text="${'$' + service.price}">100.000₫</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="tab-pane fade" id="packages" role="tabpanel">
                                                    <div class="row">
                                                        <div th:each="service : ${services}" th:if="${service.type == T(com.vaccine.entity.Service.ServiceType).PACKAGE}" 
                                                             class="col-md-6 col-lg-4 mb-4">
                                                            <div class="card service-card h-100">
                                                                <div class="card-body">
                                                                    <input type="radio" name="serviceId" th:id="${'service-' + service.id}" th:value="${service.id}" th:field="*{serviceId}" class="d-none" />
                                                                    <div class="d-flex justify-content-between mb-3">
                                                                        <h5 class="card-title" th:text="${service.name}">Tên dịch vụ</h5>
                                                                        <span class="badge bg-success" th:text="${service.type}">Loại</span>
                                                                    </div>
                                                                    <p class="card-text" th:text="${#strings.abbreviate(service.description, 120)}">Mô tả dịch vụ</p>
                                                                    <div class="mb-3">
                                                                        <small class="text-muted">Vắc-xin bao gồm:</small>
                                                                        <ul class="list-group list-group-flush small">
                                                                            <li class="list-group-item px-0" th:each="vaccine : ${service.vaccines}" th:text="${vaccine.name}">Tên vắc-xin</li>
                                                                        </ul>
                                                                    </div>
                                                                    <div class="d-flex justify-content-between">
                                                                        <span class="fw-bold" th:text="${'$' + service.price}">100.000₫</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="tab-pane fade" id="recommended" role="tabpanel">
                                                    <div id="recommended-services" class="row">
                                                        <!-- Phần này sẽ được điền tự động với các dịch vụ được đề xuất dựa trên độ tuổi của trẻ -->
                                                        <div class="col-12 text-center py-4">
                                                            <p class="text-muted">Đang tải dịch vụ được đề xuất...</p>
                                                            <div class="spinner-border text-primary" role="status">
                                                                <span class="visually-hidden">Đang tải...</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-4 d-flex justify-content-between">
                                            <button type="button" id="step2PrevBtn" class="btn btn-outline-secondary">
                                                <i class="fas fa-arrow-left"></i> Quay lại
                                            </button>
                                            <button type="button" id="step2NextBtn" class="btn btn-primary" disabled>
                                                Tiếp theo <i class="fas fa-arrow-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Step 3: Choose Date & Time -->
                                    <div class="tab-pane fade" id="step3" role="tabpanel" aria-labelledby="step3-tab">
                                        <h5 class="mb-4">Chọn ngày & giờ hẹn</h5>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-4">
                                                    <label for="appointmentDate" class="form-label">Ngày hẹn</label>
                                                    <input type="date" class="form-control" id="appointmentDate" name="appointmentDate" 
                                                           th:field="*{appointmentDate}"
                                                           th:min="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}" required>
                                                </div>
                                                
                                                <div class="mb-4">
                                                    <label class="form-label">Khung giờ có sẵn</label>
                                                    <div id="timeSlots" class="row g-3">
                                                        <!-- Các khung giờ sẽ được tạo tự động ở đây -->
                                                        <div class="col-md-4">
                                                            <div class="card text-center p-2 time-slot">
                                                                <span>09:00</span>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="card text-center p-2 time-slot">
                                                                <span>09:30</span>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="card text-center p-2 time-slot">
                                                                <span>10:00</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <input type="hidden" id="appointmentTime" th:field="*{appointmentDate}" />
                                                </div>
                                                
                                                <div class="form-group">
                                                    <label for="notes" class="form-label">Ghi chú bổ sung</label>
                                                    <textarea class="form-control" id="notes" name="notes" th:field="*{notes}" rows="3" 
                                                              placeholder="Các yêu cầu đặc biệt hoặc thông tin bổ sung"></textarea>
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-6">
                                                <div class="card shadow h-100">
                                                    <div class="card-header py-3">
                                                        <h6 class="m-0 font-weight-bold text-primary">Quy định đặt lịch</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <h6>Giờ làm việc</h6>
                                                        <ul class="mb-4">
                                                            <li>Thứ Hai đến Thứ Sáu: 8:00 - 17:00</li>
                                                            <li>Thứ Bảy và Chủ Nhật: Đóng cửa</li>
                                                        </ul>
                                                        
                                                        <h6>Chính sách hủy lịch</h6>
                                                        <ul class="mb-4">
                                                            <li>Cần hủy lịch ít nhất 24 giờ trước giờ hẹn</li>
                                                            <li>Hủy muộn có thể phải trả phí</li>
                                                            <li>Không đến mà không báo trước sẽ phải trả toàn bộ phí</li>
                                                        </ul>
                                                        
                                                        <h6>Cần mang theo</h6>
                                                        <ul>
                                                            <li>Sổ theo dõi tiêm chủng của trẻ (nếu có)</li>
                                                            <li>Giấy tờ tùy thân</li>
                                                            <li>Thông tin bảo hiểm (nếu có)</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-4 d-flex justify-content-between">
                                            <button type="button" id="step3PrevBtn" class="btn btn-outline-secondary">
                                                <i class="fas fa-arrow-left"></i> Quay lại
                                            </button>
                                            <button type="button" id="step3NextBtn" class="btn btn-primary" disabled>
                                                Tiếp theo <i class="fas fa-arrow-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Step 4: Confirm & Book -->
                                    <div class="tab-pane fade" id="step4" role="tabpanel" aria-labelledby="step4-tab">
                                        <h5 class="mb-4">Xác nhận thông tin lịch hẹn</h5>
                                        
                                        <div class="row">
                                            <div class="col-md-8">
                                                <div class="card shadow mb-4">
                                                    <div class="card-header py-3">
                                                        <h6 class="m-0 font-weight-bold text-primary">Tóm tắt lịch hẹn</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="row mb-3">
                                                            <div class="col-sm-4 text-muted">Trẻ:</div>
                                                            <div class="col-sm-8 fw-bold" id="summary-child">-</div>
                                                        </div>
                                                        <div class="row mb-3">
                                                            <div class="col-sm-4 text-muted">Dịch vụ:</div>
                                                            <div class="col-sm-8" id="summary-service">-</div>
                                                        </div>
                                                        <div class="row mb-3">
                                                            <div class="col-sm-4 text-muted">Giá tiền:</div>
                                                            <div class="col-sm-8 fw-bold" id="summary-price">-</div>
                                                        </div>
                                                        <div class="row mb-3">
                                                            <div class="col-sm-4 text-muted">Ngày & giờ:</div>
                                                            <div class="col-sm-8" id="summary-datetime">-</div>
                                                        </div>
                                                        <div class="row mb-3">
                                                            <div class="col-sm-4 text-muted">Ghi chú:</div>
                                                            <div class="col-sm-8" id="summary-notes">-</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-4">
                                                <div class="card border-left-info shadow h-100 py-2 mb-4">
                                                    <div class="card-body">
                                                        <div class="row no-gutters align-items-center">
                                                            <div class="col mr-2">
                                                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                                                    Thông tin thanh toán</div>
                                                                <div class="h5 mb-0 font-weight-bold text-gray-800">Thanh toán tại phòng khám</div>
                                                                <small class="text-muted">Thanh toán sẽ được thu sau khi tiêm chủng</small>
                                                            </div>
                                                            <div class="col-auto">
                                                                <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input" type="checkbox" id="termsCheck" required>
                                                    <label class="form-check-label" for="termsCheck">
                                                        Tôi đồng ý với <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">điều khoản và điều kiện</a>
                                                    </label>
                                                </div>
                                                
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input" type="checkbox" id="reminderCheck" checked>
                                                    <label class="form-check-label" for="reminderCheck">
                                                        Gửi cho tôi thông báo nhắc lịch hẹn
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-4 d-flex justify-content-between">
                                            <button type="button" id="step4PrevBtn" class="btn btn-outline-secondary">
                                                <i class="fas fa-arrow-left"></i> Quay lại
                                            </button>
                                            <button type="submit" id="submitBtn" class="btn btn-success" disabled>
                                                <i class="fas fa-check"></i> Xác nhận & Đặt lịch
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Terms and Conditions Modal -->
            <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="termsModalLabel">Điều khoản và Điều kiện</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <h6>Điều khoản đặt lịch</h6>
                            <p>Khi đặt lịch hẹn, bạn đồng ý với các điều khoản sau:</p>
                            <ul>
                                <li>Bạn phải đến trước 15 phút so với giờ hẹn đã đặt.</li>
                                <li>Việc hủy lịch phải được thực hiện ít nhất 24 giờ trước giờ hẹn.</li>
                                <li>Hủy muộn hoặc không đến có thể phải trả phí.</li>
                                <li>Thanh toán sẽ được thực hiện tại thời điểm sử dụng dịch vụ.</li>
                                <li>Bạn đồng ý cung cấp thông tin chính xác và đầy đủ về lịch sử sức khỏe của trẻ.</li>
                            </ul>
                            
                            <h6>Chấp thuận y tế</h6>
                            <p>Khi xác nhận lịch hẹn này, bạn đang đồng ý cho phép con mình nhận các vắc-xin trong dịch vụ đã chọn. Bạn hiểu rằng:</p>
                            <ul>
                                <li>Tất cả vắc-xin đều có một số rủi ro về tác dụng phụ.</li>
                                <li>Bạn sẽ được cung cấp Tờ thông tin về vắc-xin trước khi tiêm chủng.</li>
                                <li>Bạn sẽ có cơ hội đặt câu hỏi trước khi tiêm chủng.</li>
                                <li>Bạn có thể rút lại sự đồng ý bất cứ lúc nào trước khi tiêm vắc-xin.</li>
                            </ul>
                            
                            <h6>Chính sách bảo mật</h6>
                            <p>Chúng tôi tôn trọng quyền riêng tư của bạn và sẽ bảo vệ thông tin cá nhân của bạn theo quy định của pháp luật hiện hành. Thông tin của bạn sẽ chỉ được sử dụng cho:</p>
                            <ul>
                                <li>Cung cấp và quản lý dịch vụ tiêm chủng.</li>
                                <li>Gửi nhắc nhở lịch hẹn và cập nhật về tiêm chủng.</li>
                                <li>Duy trì hồ sơ tiêm chủng theo yêu cầu của pháp luật.</li>
                                <li>Mục đích thanh toán và quản lý.</li>
                            </ul>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Tôi đã hiểu</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div layout:fragment="scripts">
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Variables
                const form = document.getElementById('appointmentForm');
                const childCards = document.querySelectorAll('.child-card');
                const serviceCards = document.querySelectorAll('.service-card');
                const timeSlots = document.querySelectorAll('.time-slot');
                const appointmentDateInput = document.getElementById('appointmentDate');
                const appointmentTimeInput = document.getElementById('appointmentTime');
                const termsCheck = document.getElementById('termsCheck');
                
                // Buttons
                const step1NextBtn = document.getElementById('step1NextBtn');
                const step2PrevBtn = document.getElementById('step2PrevBtn');
                const step2NextBtn = document.getElementById('step2NextBtn');
                const step3PrevBtn = document.getElementById('step3PrevBtn');
                const step3NextBtn = document.getElementById('step3NextBtn');
                const step4PrevBtn = document.getElementById('step4PrevBtn');
                const submitBtn = document.getElementById('submitBtn');
                
                // Tab elements
                const step1Tab = document.getElementById('step1-tab');
                const step2Tab = document.getElementById('step2-tab');
                const step3Tab = document.getElementById('step3-tab');
                const step4Tab = document.getElementById('step4-tab');
                
                // Progress bar
                const progressBar = document.getElementById('booking-progress');
                
                // Summary elements
                const summaryChild = document.getElementById('summary-child');
                const summaryService = document.getElementById('summary-service');
                const summaryPrice = document.getElementById('summary-price');
                const summaryDateTime = document.getElementById('summary-datetime');
                const summaryNotes = document.getElementById('summary-notes');
                
                // Child selection
                childCards.forEach(card => {
                    card.addEventListener('click', function() {
                        // Reset previous selection
                        childCards.forEach(c => c.classList.remove('selected'));
                        
                        // Select this card
                        card.classList.add('selected');
                        
                        // Find the radio input and check it
                        const radioInput = card.querySelector('input[type="radio"]');
                        radioInput.checked = true;
                        
                        // Enable the next button
                        step1NextBtn.disabled = false;
                        
                        // Update summary
                        summaryChild.textContent = card.querySelector('.card-title').textContent;
                        
                        // Fetch recommended services when child is selected
                        fetchRecommendedServices(radioInput.value);
                    });
                });
                
                // Service selection
                serviceCards.forEach(card => {
                    card.addEventListener('click', function() {
                        // Reset previous selection
                        serviceCards.forEach(c => c.classList.remove('selected'));
                        
                        // Select this card
                        card.classList.add('selected');
                        
                        // Find the radio input and check it
                        const radioInput = card.querySelector('input[type="radio"]');
                        radioInput.checked = true;
                        
                        // Enable the next button
                        step2NextBtn.disabled = false;
                        
                        // Update summary
                        summaryService.textContent = card.querySelector('.card-title').textContent;
                        summaryPrice.textContent = card.querySelector('.fw-bold').textContent;
                    });
                });
                
                // Time slot selection
                timeSlots.forEach(slot => {
                    slot.addEventListener('click', function() {
                        if (slot.classList.contains('unavailable')) {
                            return;
                        }
                        
                        // Reset previous selection
                        timeSlots.forEach(s => s.classList.remove('selected'));
                        
                        // Select this slot
                        slot.classList.add('selected');
                        
                        // Update the hidden time input
                        const time = slot.querySelector('span').textContent;
                        const date = appointmentDateInput.value;
                        
                        // Convert time to 24-hour format for datetime-local input
                        const timeComponents = time.match(/(\d+):(\d+) ([AP]M)/);
                        let hours = parseInt(timeComponents[1]);
                        const minutes = timeComponents[2];
                        const ampm = timeComponents[3];
                        
                        if (ampm === 'PM' && hours < 12) {
                            hours += 12;
                        } else if (ampm === 'AM' && hours === 12) {
                            hours = 0;
                        }
                        
                        const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes}`;
                        
                        appointmentTimeInput.value = `${date}T${formattedTime}`;
                        
                        // Enable the next button
                        step3NextBtn.disabled = false;
                        
                        // Update summary
                        const dateObj = new Date(`${date}T${formattedTime}`);
                        summaryDateTime.textContent = dateObj.toLocaleString();
                    });
                });
                
                // Terms checkbox
                termsCheck.addEventListener('change', function() {
                    submitBtn.disabled = !termsCheck.checked;
                });
                
                // Date input change - fetch available time slots
                appointmentDateInput.addEventListener('change', function() {
                    fetchTimeSlots(appointmentDateInput.value);
                    
                    // Reset time selection
                    timeSlots.forEach(s => s.classList.remove('selected'));
                    step3NextBtn.disabled = true;
                });
                
                // Notes input change
                document.getElementById('notes').addEventListener('input', function() {
                    summaryNotes.textContent = this.value || '-';
                });
                
                // Navigation buttons
                step1NextBtn.addEventListener('click', function() {
                    // Go to step 2
                    new bootstrap.Tab(step2Tab).show();
                    step2Tab.classList.remove('disabled');
                    progressBar.style.width = '50%';
                    progressBar.textContent = 'Bước 2/4';
                    progressBar.setAttribute('aria-valuenow', '50');
                });
                
                step2PrevBtn.addEventListener('click', function() {
                    // Go back to step 1
                    new bootstrap.Tab(step1Tab).show();
                    progressBar.style.width = '25%';
                    progressBar.textContent = 'Bước 1/4';
                    progressBar.setAttribute('aria-valuenow', '25');
                });
                
                step2NextBtn.addEventListener('click', function() {
                    // Go to step 3
                    new bootstrap.Tab(step3Tab).show();
                    step3Tab.classList.remove('disabled');
                    progressBar.style.width = '75%';
                    progressBar.textContent = 'Bước 3/4';
                    progressBar.setAttribute('aria-valuenow', '75');
                    
                    // Set the min date to today
                    const today = new Date().toISOString().split('T')[0];
                    appointmentDateInput.min = today;
                    appointmentDateInput.value = today;
                    
                    // Fetch available time slots for today
                    fetchTimeSlots(today);
                });
                
                step3PrevBtn.addEventListener('click', function() {
                    // Go back to step 2
                    new bootstrap.Tab(step2Tab).show();
                    progressBar.style.width = '50%';
                    progressBar.textContent = 'Bước 2/4';
                    progressBar.setAttribute('aria-valuenow', '50');
                });
                
                step3NextBtn.addEventListener('click', function() {
                    // Go to step 4
                    new bootstrap.Tab(step4Tab).show();
                    step4Tab.classList.remove('disabled');
                    progressBar.style.width = '100%';
                    progressBar.textContent = 'Bước 4/4';
                    progressBar.setAttribute('aria-valuenow', '100');
                });
                
                step4PrevBtn.addEventListener('click', function() {
                    // Go back to step 3
                    new bootstrap.Tab(step3Tab).show();
                    progressBar.style.width = '75%';
                    progressBar.textContent = 'Bước 3/4';
                    progressBar.setAttribute('aria-valuenow', '75');
                });
                
                // Functions
                function fetchRecommendedServices(childId) {
                    const recommendedServicesContainer = document.getElementById('recommended-services');
                    recommendedServicesContainer.innerHTML = `
                        <div class="col-12 text-center py-4">
                            <p class="text-muted">Đang tải dịch vụ được đề xuất...</p>
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Đang tải...</span>
                            </div>
                        </div>
                    `;
                    
                    // Fetch recommended services for this child
                    fetch(`/api/vaccinations/recommended/${childId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.length === 0) {
                                recommendedServicesContainer.innerHTML = `
                                    <div class="col-12 text-center py-4">
                                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                        <h5>Không Có Đề Xuất</h5>
                                        <p class="text-muted">Tất cả vắc-xin của trẻ đều đã được cập nhật.</p>
                                    </div>
                                `;
                                return;
                            }
                            
                            // Get vaccine IDs from the recommended vaccinations
                            const vaccineIds = data.map(vaccination => vaccination.vaccine.id);
                            
                            // Filter services that include these vaccines
                            fetch('/api/services')
                                .then(response => response.json())
                                .then(services => {
                                    const recommendedServices = services.filter(service => {
                                        return service.vaccines.some(vaccine => vaccineIds.includes(vaccine.id));
                                    });
                                    
                                    if (recommendedServices.length === 0) {
                                        recommendedServicesContainer.innerHTML = `
                                            <div class="col-12 text-center py-4">
                                                <i class="fas fa-info-circle fa-3x text-info mb-3"></i>
                                                <h5>Không Có Dịch Vụ Phù Hợp</h5>
                                                <p class="text-muted">Không tìm thấy dịch vụ nào phù hợp với vắc-xin được đề xuất. Vui lòng chọn từ tab Vắc-xin Đơn Lẻ.</p>
                                            </div>
                                        `;
                                        return;
                                    }
                                    
                                    // Tạo HTML cho mỗi dịch vụ được đề xuất
                                    let html = '';
                                    recommendedServices.forEach(service => {
                                        html += `
                                            <div class="col-md-6 col-lg-4 mb-4">
                                                <div class="card service-card h-100">
                                                    <div class="card-body">
                                                        <input type="radio" name="serviceId" id="service-${service.id}" value="${service.id}" class="d-none" />
                                                        <div class="d-flex justify-content-between mb-3">
                                                            <h5 class="card-title">${service.name}</h5>
                                                            <span class="badge ${service.type === 'INDIVIDUAL_VACCINE' ? 'bg-info' : service.type === 'PACKAGE' ? 'bg-success' : 'bg-warning'}">${service.type}</span>
                                                        </div>
                                                        <p class="card-text">${service.description.length > 120 ? service.description.substring(0, 120) + '...' : service.description}</p>
                                                        <div class="mb-3">
                                                            <small class="text-muted">Vắc-xin bao gồm:</small>
                                                            <ul class="list-group list-group-flush small">
                                                                ${service.vaccines.map(vaccine => `<li class="list-group-item px-0 ${vaccineIds.includes(vaccine.id) ? 'fw-bold text-success' : ''}">${vaccine.name} ${vaccineIds.includes(vaccine.id) ? '<i class="fas fa-check-circle text-success ms-1"></i>' : ''}</li>`).join('')}
                                                                ${service.vaccines.length === 0 ? '<li class="list-group-item px-0 text-muted">Tùy chỉnh vắc-xin theo nhu cầu</li>' : ''}
                                                            </ul>
                                                        </div>
                                                        <div class="d-flex justify-content-between">
                                                            <span class="fw-bold">₫${service.price}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    });
                                    
                                    recommendedServicesContainer.innerHTML = html;
                                    
                                    // Thêm trình lắng nghe sự kiện click cho các thẻ dịch vụ mới tạo
                                    document.querySelectorAll('#recommended .service-card').forEach(card => {
                                        card.addEventListener('click', function() {
                                            // Đặt lại lựa chọn trước đó
                                            serviceCards.forEach(c => c.classList.remove('selected'));
                                            document.querySelectorAll('#recommended .service-card').forEach(c => c.classList.remove('selected'));
                                            
                                            // Chọn thẻ này
                                            card.classList.add('selected');
                                            
                                            // Tìm input radio và chọn nó
                                            const radioInput = card.querySelector('input[type="radio"]');
                                            radioInput.checked = true;
                                            
                                            // Kích hoạt nút tiếp theo
                                            step2NextBtn.disabled = false;
                                            
                                            // Cập nhật tóm tắt
                                            summaryService.textContent = card.querySelector('.card-title').textContent;
                                            summaryPrice.textContent = card.querySelector('.fw-bold').textContent;
                                        });
                                    });
                                })
                                .catch(error => {
                                    console.error('Error fetching services:', error);
                                    recommendedServicesContainer.innerHTML = `
                                        <div class="col-12 text-center py-4">
                                            <i class="fas fa-exclamation-circle fa-3x text-danger mb-3"></i>
                                            <h5>Lỗi</h5>
                                            <p class="text-muted">Không thể tải dịch vụ được đề xuất. Vui lòng thử lại.</p>
                                        </div>
                                    `;
                                });
                        })
                        .catch(error => {
                            console.error('Error fetching recommended vaccinations:', error);
                            recommendedServicesContainer.innerHTML = `
                                <div class="col-12 text-center py-4">
                                    <i class="fas fa-exclamation-circle fa-3x text-danger mb-3"></i>
                                    <h5>Lỗi</h5>
                                    <p class="text-muted">Không thể tải đề xuất vắc-xin. Vui lòng thử lại.</p>
                                </div>
                            `;
                        });
                }
                
                function fetchTimeSlots(date) {
                    const timeSlotsContainer = document.getElementById('timeSlots');
                    timeSlotsContainer.innerHTML = `
                        <div class="col-12 text-center py-4">
                            <p class="text-muted">Đang tải khung giờ khả dụng...</p>
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Đang tải...</span>
                            </div>
                        </div>
                    `;
                    
                    // Kiểm tra xem ngày đã chọn có phải là cuối tuần không
                    const selectedDate = new Date(date);
                    const day = selectedDate.getDay();
                    if (day === 0 || day === 6) { // 0 = Sunday, 6 = Saturday
                        timeSlotsContainer.innerHTML = `
                            <div class="col-12 text-center py-4">
                                <i class="fas fa-calendar-times fa-3x text-danger mb-3"></i>
                                <h5>Đóng Cửa Cuối Tuần</h5>
                                <p class="text-muted">Trung tâm chúng tôi đóng cửa vào cuối tuần. Vui lòng chọn ngày trong tuần.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Thông thường chúng ta sẽ lấy các khung giờ khả dụng từ máy chủ
                    // Trong ví dụ này, chúng ta sẽ tạo các khung giờ từ 8 giờ sáng đến 5 giờ chiều
                    const timeSlots = [];
                    for (let hour = 8; hour < 17; hour++) {
                        for (let minute = 0; minute < 60; minute += 30) {
                            const ampm = hour >= 12 ? 'PM' : 'AM';
                            const displayHour = hour % 12 || 12;
                            const displayMinute = minute === 0 ? '00' : minute;
                            timeSlots.push(`${displayHour}:${displayMinute} ${ampm}`);
                        }
                    }
                    
                    // Tạo HTML cho các khung giờ
                    let html = '';
                    timeSlots.forEach((slot, index) => {
                        // Đánh dấu ngẫu nhiên một số khung giờ là không khả dụng cho mục đích minh họa
                        const isUnavailable = Math.random() < 0.3;
                        html += `
                            <div class="col-md-4 col-6 mb-3">
                                <div class="card text-center p-2 time-slot ${isUnavailable ? 'unavailable' : ''}">
                                    <span>${slot}</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    timeSlotsContainer.innerHTML = html;
                    
                    // Thêm trình lắng nghe sự kiện click cho các khung giờ mới tạo
                    document.querySelectorAll('.time-slot:not(.unavailable)').forEach(slot => {
                        slot.addEventListener('click', function() {
                            // Đặt lại lựa chọn trước đó
                            document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
                            
                            // Chọn khung giờ này
                            slot.classList.add('selected');
                            
                            // Cập nhật trường input thời gian ẩn
                            const time = slot.querySelector('span').textContent;
                            const date = appointmentDateInput.value;
                            
                            // Chuyển đổi thời gian sang định dạng 24 giờ cho input datetime-local
                            const timeComponents = time.match(/(\d+):(\d+) ([AP]M)/);
                            let hours = parseInt(timeComponents[1]);
                            const minutes = timeComponents[2];
                            const ampm = timeComponents[3];
                            
                            if (ampm === 'PM' && hours < 12) {
                                hours += 12;
                            } else if (ampm === 'AM' && hours === 12) {
                                hours = 0;
                            }
                            
                            const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes}`;
                            
                            appointmentTimeInput.value = `${date}T${formattedTime}`;
                            
                            // Kích hoạt nút tiếp theo
                            step3NextBtn.disabled = false;
                            
                            // Cập nhật tóm tắt
                            const dateObj = new Date(`${date}T${formattedTime}`);
                            summaryDateTime.textContent = dateObj.toLocaleString();
                        });
                    });
                }
                
                // Khởi tạo biểu mẫu với các giá trị đã chọn trước (nếu có)
                const preSelectedChild = document.querySelector('input[name="childId"]:checked');
                if (preSelectedChild) {
                    const childCard = preSelectedChild.closest('.child-card');
                    childCard.classList.add('selected');
                    step1NextBtn.disabled = false;
                    summaryChild.textContent = childCard.querySelector('.card-title').textContent;
                    fetchRecommendedServices(preSelectedChild.value);
                }
                
                const preSelectedService = document.querySelector('input[name="serviceId"]:checked');
                if (preSelectedService) {
                    const serviceCard = preSelectedService.closest('.service-card');
                    serviceCard.classList.add('selected');
                    step2NextBtn.disabled = false;
                    summaryService.textContent = serviceCard.querySelector('.card-title').textContent;
                    summaryPrice.textContent = serviceCard.querySelector('.fw-bold').textContent;
                }
            });
        </script>
    </div>
</body>
</html>
